library(purrr)
library(dplyr)
library(stringr)
library(jsonlite)

path_leyes    <- "~/../databases/impo/leyes"
path_decretos <- "~/../databases/impo/decretos_ley"

files_leyes    <- list.files(path_leyes)
files_decretos <- list.files(path_decretos)

df_decreto_ley_articulos <- tibble()
df_decreto_ley_titulos   <- tibble()

# loopeo en todas las leyes y voy aÃ±adiendo al df una a una
names_col <- c("nroArticulo", "secArticulo", "tituloArticulo", "urlArticulo", "textoArticulo")

empieza <- Sys.time()

for(i in 1:length(files_decretos)){
  
  path <- file.path(path_decretos, files_decretos[[i]])
  
  json_file <- rjson::fromJSON(file = path)
  articulos <- json_file$articulos
  
  aux_articulo <- map_dfr(articulos, `[`, names_col) %>% 
    mutate(id_ley = paste0(json_file$nroNorma, "_", json_file$anioNorma))
  
  aux_titulo <- tibble(
    id_ley             = paste0(json_file$nroNorma, "_", json_file$anioNorma),
    tipo_norma         = json_file$tipoNorma,
    nro_norma          = json_file$nroNorma,
    anio_norma         = json_file$anioNorma,
    nombre_norma       = json_file$nombreNorma,
    leyenda            = json_file$leyenda,
    fecha_publicacion  = json_file$fechaPublicacion,
    fecha_promulgacion = json_file$fechaPromulgacion,
    vistos             = json_file$vistos,
    firmantes          = json_file$firmantes,
    tipo               = 'decreto-ley')
  
  df_decreto_ley_articulos <- bind_rows(df_decreto_ley_articulos, aux_articulo)
  df_decreto_ley_titulos   <- bind_rows(df_decreto_ley_titulos, aux_titulo)
  
  }
termina <- Sys.time()
termina-empieza

rm(empieza, termina, json_file, path_decretos, files_decretos)



# # Scrapping constitucion
# #url_impo <- "https://www.impo.com.uy/resources/basesIMPO.json"
# url_impo_cons <- "https://www.impo.com.uy/bases/constitucion/1967-1967?json=true"
# 
# 
# json_file <-  getURL(url_impo_cons) %>% 
#   jsonlite::fromJSON()
# 
# consitutcion <- json_file$articulos %>% 
#   mutate(tipo_norma        = json_file$tipoNorma,
#          leyenda           = json_file$leyenda,
#          fecha_publicacion = json_file$fechaPublicacion) %>% 
#   select(tipo_norma, leyenda, fecha_publicacion, everything())
# 

df_ley_articulos <- tibble()
df_ley_titulos   <- tibble()

empieza <- Sys.time()

for(i in 1:length(files_leyes)){
  
  path <- file.path(path_leyes, files_leyes[[i]])
  
  json_file <- rjson::fromJSON(file = path)
  articulos <- json_file$articulos
  
  aux_articulo <- map_dfr(articulos, `[`, names_col) %>% 
    mutate(id_ley = paste0(json_file$nroNorma, "_", json_file$anioNorma))
  
  aux_titulo <- tibble(
    id_ley             = paste0(json_file$nroNorma, "_", json_file$anioNorma),
    tipo_norma         = json_file$tipoNorma,
    nro_norma          = json_file$nroNorma,
    anio_norma         = json_file$anioNorma,
    nombre_norma       = json_file$nombreNorma,
    leyenda            = json_file$leyenda,
    fecha_publicacion  = json_file$fechaPublicacion,
    fecha_promulgacion = json_file$fechaPromulgacion,
    vistos             = json_file$vistos,
    firmantes          = json_file$firmantes,
    tipo               = 'ley')
  
  df_ley_articulos <- bind_rows(df_ley_articulos, aux_articulo)
  df_ley_titulos   <- bind_rows(df_ley_titulos, aux_titulo)
  
}
termina <- Sys.time()
termina-empieza

rm(articulos, aux_articulo, aux_titulo, json_file, empieza, termina, files_leyes, names_col, path, path_leyes, i)

df_leyes_articulos <- bind_rows(df_decreto_ley_articulos, df_ley_articulos) %>% 
  arrange(id_ley)

df_leyes_titulos   <- bind_rows(df_decreto_ley_titulos, df_ley_titulos) %>% 
  arrange(id_ley) 

Encoding(df_leyes_articulos$tituloArticulo) <- 'latin1'
Encoding(df_leyes_articulos$textoArticulo)  <- 'latin1'

rm(df_decreto_ley_articulos, df_ley_articulos, df_decreto_ley_titulos, df_ley_titulos)

saveRDS(df_leyes_titulos, "data/df_leyes_titulos.rds")
saveRDS(df_leyes_articulos, "data/df_leyes_articulos.rds")
